<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<div id="gpx-map" style="height: 400px; z-index: 1;"></div>

<script>
  (function() {
    var initMap = function() {
      var mapElement = document.getElementById('gpx-map');
      if (!mapElement || mapElement._leaflet_id) return;

      var map = L.map('gpx-map');

      L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      var gpxUrl = "{{ include.track | relative_url }}";
      new L.GPX(gpxUrl, {
        async: true,
        marker_options: {
          startIconUrl: 'https://cdn.jsdelivr.net/gh/mpetazzoni/leaflet-gpx@1.7.0/pin-icon-start.png',
          endIconUrl: 'https://cdn.jsdelivr.net/gh/mpetazzoni/leaflet-gpx@1.7.0/pin-icon-end.png',
          shadowUrl: 'https://cdn.jsdelivr.net/gh/mpetazzoni/leaflet-gpx@1.7.0/pin-shadow.png'
        }
      }).on('loaded', function(e) {
        map.fitBounds(e.target.getBounds());
      }).addTo(map);
    };

    /* Handle Pjax and normal load */
    initMap();

    /* Listen for Pjax success if Chirpy uses it */
    document.addEventListener('pjax:success', initMap);
  })();
</script>
